<!DOCTYPE html>
<html lang="en">
<head>
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5319541186981982"
     crossorigin="anonymous"></script>
  <meta charset="UTF-8" />
  <title>DropScore Draft</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #0e1a2b;
      color: white;
      padding: 2rem;
      margin: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h1, h2 {
      color: #f44336;
      text-align: center;
    }
    .screen { display: none; width: 100%; max-width: 600px; }
    .visible { display: block; }
    input, button {
      width: 100%;
      padding: 0.75rem;
      margin: 0.5rem 0;
      border: none;
      border-radius: 6px;
      font-size: 1rem;
    }
    button {
      background: #3498db;
      color: white;
      cursor: pointer;
    }
    ul {
      list-style: none;
      padding: 0;
    }
    li {
      background: #1f2f47;
      margin: 6px 0;
      padding: 10px;
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
  </style>
</head>
<body>

  
<div id="homeScreen" class="screen visible">
  <h1>🏀 DropScore Draft</h1>
  <input type="text" id="usernameInput" placeholder="Enter your name" />
  <input type="email" id="emailInput" placeholder="Enter your email" />
  <button onclick="startDraft()">Start Draft</button>

  <h2>📊 Live Leaderboard</h2>
  <ul id="liveLeaderboardList"></ul>
</div>


  <div id="draftUI" class="screen">
    <h2>Pick your top 10 players</h2>
    <h3>Your Picks</h3>
    <ul id="draftBoard"></ul>

    <input type="text" id="searchInput" placeholder="Search by player or team..." oninput="renderPlayers()" />
    <ul id="playerList">Loading players...</ul>
  </div>

  <div id="leaderboardScreen" class="screen">
    <h2>🏆 Your Draft Result</h2>
    <ul id="leaderboardList"></ul>
    <button onclick="location.reload()">🔄 Draft Again</button>
  </div>

  <script>
const teamLogos = {
  ATL: "https://cdn.nba.com/logos/nba/1610612737/primary/L/logo.svg",
  BOS: "https://cdn.nba.com/logos/nba/1610612738/primary/L/logo.svg",
  BKN: "https://cdn.nba.com/logos/nba/1610612751/primary/L/logo.svg",
  CHA: "https://cdn.nba.com/logos/nba/1610612766/primary/L/logo.svg",
  CHI: "https://cdn.nba.com/logos/nba/1610612741/primary/L/logo.svg",
  CLE: "https://cdn.nba.com/logos/nba/1610612739/primary/L/logo.svg",
  DAL: "https://cdn.nba.com/logos/nba/1610612742/primary/L/logo.svg",
  DEN: "https://cdn.nba.com/logos/nba/1610612743/primary/L/logo.svg",
  DET: "https://cdn.nba.com/logos/nba/1610612765/primary/L/logo.svg",
  GSW: "https://cdn.nba.com/logos/nba/1610612744/primary/L/logo.svg",
  HOU: "https://cdn.nba.com/logos/nba/1610612745/primary/L/logo.svg",
  IND: "https://cdn.nba.com/logos/nba/1610612754/primary/L/logo.svg",
  LAC: "https://cdn.nba.com/logos/nba/1610612746/primary/L/logo.svg",
  LAL: "https://cdn.nba.com/logos/nba/1610612747/primary/L/logo.svg",
  MEM: "https://cdn.nba.com/logos/nba/1610612763/primary/L/logo.svg",
  MIA: "https://cdn.nba.com/logos/nba/1610612748/primary/L/logo.svg",
  MIL: "https://cdn.nba.com/logos/nba/1610612749/primary/L/logo.svg",
  MIN: "https://cdn.nba.com/logos/nba/1610612750/primary/L/logo.svg",
  NOP: "https://cdn.nba.com/logos/nba/1610612740/primary/L/logo.svg",
  NYK: "https://cdn.nba.com/logos/nba/1610612752/primary/L/logo.svg",
  OKC: "https://cdn.nba.com/logos/nba/1610612760/primary/L/logo.svg",
  ORL: "https://cdn.nba.com/logos/nba/1610612753/primary/L/logo.svg",
  PHI: "https://cdn.nba.com/logos/nba/1610612755/primary/L/logo.svg",
  PHO: "https://cdn.nba.com/logos/nba/1610612756/primary/L/logo.svg",
  POR: "https://cdn.nba.com/logos/nba/1610612757/primary/L/logo.svg",
  SAC: "https://cdn.nba.com/logos/nba/1610612758/primary/L/logo.svg",
  SAS: "https://cdn.nba.com/logos/nba/1610612759/primary/L/logo.svg",
  TOR: "https://cdn.nba.com/logos/nba/1610612761/primary/L/logo.svg",
  UTA: "https://cdn.nba.com/logos/nba/1610612762/primary/L/logo.svg",
  WAS: "https://cdn.nba.com/logos/nba/1610612764/primary/L/logo.svg"
};

const playerAPI = "https://api.sheety.co/8bc8ea9aa07e26b76e867fe4d92cee28/nbaPlayoffData/draftPicks";
const statsAPI = "https://api.sheety.co/8bc8ea9aa07e26b76e867fe4d92cee28/nbaPlayoffData/playerStats";

let drafted = new Set();
let draftPicks = [];
let players = [];
let submissionInProgress = false;

function startDraft() {
  const username = document.getElementById("usernameInput").value.trim();
  const email = document.getElementById("emailInput").value.trim();

  if (!username || !email) {
    alert("Please enter both your name and email.");
    return;
  }

  window.currentUser = username;
  window.currentEmail = email;

  console.log("✅ Captured:", window.currentUser, window.currentEmail);

  drafted = new Set();
  draftPicks = [];

  document.getElementById("homeScreen").classList.remove("visible");
  document.getElementById("draftUI").classList.add("visible");

  fetch(playerAPI)
    .then(res => res.json())
    .then(data => {
      players = data.draftPicks || [];
      renderPlayers();
    })
    .catch(err => {
      console.error("⚠️ Failed to load players:", err);
      alert("Failed to load player list.");
    });
}


function renderPlayers() {
  const list = document.getElementById("playerList");
  const search = (document.getElementById("searchInput")?.value || "").toLowerCase();
  list.innerHTML = "";

  const filtered = players.filter(p => {
    const name = p.player.toLowerCase();
    const team = p.team.toLowerCase();
    return !drafted.has(p.player) && (name.includes(search) || team.includes(search));
  });

  filtered.forEach(p => {
    const li = document.createElement("li");

    const wrapper = document.createElement("div");
    wrapper.style.display = "flex";
    wrapper.style.justifyContent = "space-between";
    wrapper.style.alignItems = "center";

    const infoDiv = document.createElement("div");
    const logo = teamLogos[p.team.toUpperCase()];
    infoDiv.innerHTML = logo
      ? `<img src="${logo}" style="height:20px;vertical-align:middle;margin-right:6px;"> ${p.player} (${p.team})`
      : `${p.player} (${p.team})`;

    const btn = document.createElement("button");
    btn.textContent = "Draft";
    btn.style.width = "80px";
    btn.onclick = () => draftPlayer(p.player);

    wrapper.appendChild(infoDiv);
    wrapper.appendChild(btn);
    li.appendChild(wrapper);
    list.appendChild(li);
  });
}

function draftPlayer(name) {
  draftPicks.push(name);
  drafted.add(name);
  updateDraftBoard();
  renderPlayers();

  if (draftPicks.length >= 10) endDraft();
}

function updateDraftBoard() {
  const board = document.getElementById("draftBoard");
  board.innerHTML = `<li>${draftPicks.join(", ")}</li>`;
}

async function endDraft() {
  if (submissionInProgress) {
    console.warn("⚠️ Draft already submitting... duplicate click ignored.");
    return;
  }

  submissionInProgress = true;

  try {
    const statsAPI = "https://api.sheety.co/8bc8ea9aa07e26b76e867fe4d92cee28/nbaPlayoffData/playerStats";
    const res = await fetch(statsAPI);
    const data = await res.json();
    const stats = data.playerStats || [];

    const leaderboard = document.getElementById("leaderboardList");
    leaderboard.innerHTML = "";

    let total = 0;
    draftPicks.forEach(name => {
      const stat = stats.find(p => p.player === name);
      const pts = stat ? Math.round(Number(stat.points)) : 0;
      const eliminated = stat?.eliminated?.toLowerCase() === "yes";
      const teamAbbr = stat?.team?.toUpperCase();
      const logo = teamLogos[teamAbbr];

      const li = document.createElement("li");
      li.innerHTML = `
        ${logo ? `<img src="${logo}" style="height:16px;margin-right:6px;">` : ""}
        ${eliminated ? "❌ " : ""}${name} - ${pts} pts
      `;
      if (eliminated) {
        li.style.opacity = "0.6";
        li.style.fontStyle = "italic";
      }
      leaderboard.appendChild(li);
      total += pts;
    });

    const header = document.createElement("li");
    header.innerHTML = `<strong>🏁 Total Points: ${total}</strong>`;
    header.style.marginBottom = "10px";
    leaderboard.insertBefore(header, leaderboard.firstChild);

    document.getElementById("draftUI").classList.remove("visible");
    document.getElementById("leaderboardScreen").classList.add("visible");

    const payload = {
      league: {
        leagueName: window.currentUser,
        email: window.currentEmail,
        draftPicks: JSON.stringify(draftPicks)
      }
    };

    console.log("📤 Sending payload:", payload);

    const postRes = await fetch("https://api.sheety.co/8bc8ea9aa07e26b76e867fe4d92cee28/nbaPlayoffData/leagues", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const result = await postRes.json();
    console.log("📥 Sheety response:", result);

    if (!postRes.ok) {
      alert("⚠️ Failed to save your draft. See console for details.");
      submissionInProgress = false;
    }

  } catch (err) {
    alert("❌ Error fetching stats or saving draft.");
    console.error("💥 Error in endDraft():", err);
    submissionInProgress = false;
  }
}


async function loadLiveLeaderboard() {
  const leagueAPI = "https://api.sheety.co/8bc8ea9aa07e26b76e867fe4d92cee28/nbaPlayoffData/leagues";
  const statsAPI = "https://api.sheety.co/8bc8ea9aa07e26b76e867fe4d92cee28/nbaPlayoffData/playerStats";

  try {
    const [leagueRes, statsRes] = await Promise.all([
      fetch(leagueAPI),
      fetch(statsAPI)
    ]);

    const leagueData = await leagueRes.json();
    const statsData = await statsRes.json();

    const entries = leagueData.leagues || [];
    const playerStats = statsData.playerStats || [];

    const leaderboard = [];

    entries.forEach(entry => {
      const user = entry.leagueName;
      const picks = JSON.parse(entry.draftPicks);
      let totalPoints = 0;

      const fullRoster = picks.map(name => {
        const stat = playerStats.find(p => p.player === name);
        const points = stat?.points ? Math.round(Number(stat.points)) : 0;
        const eliminated = stat?.eliminated?.toLowerCase() === "yes";
        const teamAbbr = stat?.team?.toUpperCase();
        return {
          name,
          points,
          eliminated,
          teamAbbr
        };
      });

      fullRoster.forEach(p => totalPoints += p.points);

      leaderboard.push({ user, totalPoints, fullRoster });
    });

    leaderboard.sort((a, b) => b.totalPoints - a.totalPoints);

    const list = document.getElementById("liveLeaderboardList");
    list.innerHTML = "";

    leaderboard.forEach((entry, index) => {
      const medal = index === 0 ? "🥇" : index === 1 ? "🥈" : index === 2 ? "🥉" : "";
      const li = document.createElement("li");
      li.style.flexDirection = "column";
      li.style.alignItems = "flex-start";

      const header = document.createElement("div");
      header.style.display = "flex";
      header.style.justifyContent = "space-between";
      header.style.alignItems = "center";
      header.style.width = "100%";

      const label = document.createElement("strong");
      label.textContent = `${medal} ${entry.user} — ${entry.totalPoints} pts`;

      const toggleBtn = document.createElement("button");
      toggleBtn.textContent = "View Players";
      toggleBtn.style.width = "100px";
      toggleBtn.style.padding = "6px 10px";
      toggleBtn.style.background = "#2980b9";
      toggleBtn.style.color = "#fff";
      toggleBtn.style.border = "none";
      toggleBtn.style.borderRadius = "5px";
      toggleBtn.style.cursor = "pointer";
      toggleBtn.style.fontSize = "0.9rem";

      header.appendChild(label);
      header.appendChild(toggleBtn);
      li.appendChild(header);

      const playerList = document.createElement("ul");
      playerList.style.marginTop = "8px";
      playerList.style.display = "none";

      entry.fullRoster.forEach(player => {
        const detail = document.createElement("li");

        const logo = teamLogos[player.teamAbbr];
        detail.innerHTML = `
          ${logo ? `<img src="${logo}" style="height:16px;margin-right:6px;">` : ""}
          ${player.eliminated ? "❌ " : ""}${player.name} - ${player.points} pts
        `;

        if (player.eliminated) {
          detail.style.opacity = "0.6";
          detail.style.fontStyle = "italic";
        }

        detail.style.marginLeft = "16px";
        detail.style.fontSize = "0.95rem";
        playerList.appendChild(detail);
      });

      toggleBtn.onclick = () => {
        const visible = playerList.style.display === "block";
        playerList.style.display = visible ? "none" : "block";
        toggleBtn.textContent = visible ? "View Players" : "Hide Players";
      };

      li.appendChild(playerList);
      list.appendChild(li);
    });

  } catch (err) {
    console.error("❌ Error loading live leaderboard:", err);
    alert("Failed to load live leaderboard.");
  }
}

window.addEventListener("DOMContentLoaded", () => {
  loadLiveLeaderboard();
});



  </script>
</body>
</html>
