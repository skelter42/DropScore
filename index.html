<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>DropScore Draft</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #0e1a2b;
      color: white;
      padding: 2rem;
      margin: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h1, h2 {
      color: #f44336;
      text-align: center;
    }
    .screen { display: none; width: 100%; max-width: 600px; }
    .visible { display: block; }
    input, button {
      width: 100%;
      padding: 0.75rem;
      margin: 0.5rem 0;
      border: none;
      border-radius: 6px;
      font-size: 1rem;
    }
    button {
      background: #3498db;
      color: white;
      cursor: pointer;
    }
    ul {
      list-style: none;
      padding: 0;
    }
    li {
      background: #1f2f47;
      margin: 6px 0;
      padding: 10px;
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
  </style>
</head>
<body>

  <!-- Home Screen -->
  <div id="homeScreen" class="screen visible">
    <h1>üèÄ DropScore Draft</h1>
    <input type="text" id="leagueName" placeholder="Enter League Name" />
    <input type="number" id="teamCount" min="2" max="12" value="4" placeholder="Team Count" />
    <button onclick="goToDraftSetup()">Start Draft</button>
    <button onclick="viewSavedLeaderboard()">üìä View Saved Leaderboard</button>
  </div>

  <!-- Draft Setup -->
  <div id="draftScreen" class="screen">
    <h2>Enter Team Names</h2>
    <div id="teamInputs"></div>
    <button onclick="startDraft()">Begin Snake Draft</button>
  </div>

  <!-- Draft Interface -->
  <div id="draftUI" class="screen">
    <h2>Round <span id="roundNum">1</span> - <span id="currentTeam"></span>'s Turn</h2>
    <input type="text" id="searchInput" placeholder="Search by player or team..." oninput="renderPlayers()" />
    <ul id="playerList">Loading players...</ul>
    <h3>Draft Board</h3>
    <ul id="draftBoard"></ul>
    <button onclick="undoLastPick()">Undo Last Pick</button>
    <button onclick="endDraft()">End Draft</button>
  </div>

  <!-- Leaderboard Screen -->
  <div id="leaderboardScreen" class="screen">
    <h2>üèÜ Final Leaderboard</h2>
    <ul id="leaderboardList"></ul>
    <button onclick="location.reload()">üîÑ Start New Draft</button>
  </div>

  <script>
    const playerAPI = "https://api.sheety.co/8bc8ea9aa07e26b76e867fe4d92cee28/nbaPlayoffData/draftPicks";

    let teams = [];
    let draftPicks = {};
    let drafted = new Set();
    let players = [];
    let totalRounds = 5;
    let currentTeamIndex = 0;
    let round = 1;
    let reverse = false;

    function goToDraftSetup() {
      const teamCount = parseInt(document.getElementById("teamCount").value);
      const leagueName = document.getElementById("leagueName").value.trim();
      if (!leagueName || teamCount < 2 || teamCount > 12) {
        alert("Enter a valid league name and team count (2‚Äì12).");
        return;
      }

      document.getElementById("homeScreen").classList.remove("visible");
      document.getElementById("draftScreen").classList.add("visible");

      const container = document.getElementById("teamInputs");
      container.innerHTML = "";
      for (let i = 0; i < teamCount; i++) {
        container.innerHTML += `<input type="text" id="team${i}" placeholder="Team ${i + 1}" />`;
      }
    }

    function startDraft() {
      teams = [];
      const container = document.getElementById("teamInputs").children;
      for (let i = 0; i < container.length; i++) {
        const name = container[i].value || container[i].placeholder;
        teams.push(name);
        draftPicks[name] = [];
      }

      teams.sort(() => Math.random() - 0.5);

      document.getElementById("draftScreen").classList.remove("visible");
      document.getElementById("draftUI").classList.add("visible");

      document.getElementById("currentTeam").textContent = teams[currentTeamIndex];
      document.getElementById("roundNum").textContent = round;

      fetch(playerAPI)
        .then(res => res.json())
        .then(data => {
          players = data.draftPicks || [];
          renderPlayers();
        })
        .catch(err => {
          console.error(err);
          alert("Failed to load players from API.");
        });
    }

    function renderPlayers() {
      const list = document.getElementById("playerList");
      const search = document.getElementById("searchInput")?.value?.toLowerCase() || "";
      list.innerHTML = "";

      const filtered = players.filter(p => {
        const name = p.player.toLowerCase();
        const team = p.team.toLowerCase();
        return !drafted.has(p.player) && (name.includes(search) || team.includes(search));
      });

      const grouped = {};
      filtered.forEach(p => {
        if (!grouped[p.team]) grouped[p.team] = [];
        grouped[p.team].push(p);
      });

      Object.keys(grouped).sort().forEach(teamName => {
        const teamHeader = document.createElement("li");
        teamHeader.textContent = `üèÄ ${teamName}`;
        teamHeader.style.fontWeight = "bold";
        teamHeader.style.marginTop = "1rem";
        teamHeader.style.background = "none";
        teamHeader.style.padding = "4px 8px";
        list.appendChild(teamHeader);

        grouped[teamName].forEach(p => {
          const li = document.createElement("li");

          const wrapper = document.createElement("div");
          wrapper.style.display = "flex";
          wrapper.style.justifyContent = "space-between";
          wrapper.style.alignItems = "center";
          wrapper.style.width = "100%";

          const infoDiv = document.createElement("div");
          infoDiv.textContent = `${p.player}`;

          const button = document.createElement("button");
          button.textContent = "Draft";
          button.style.width = "100px";
          button.onclick = () => draftPlayer(p.player);

          wrapper.appendChild(infoDiv);
          wrapper.appendChild(button);
          li.appendChild(wrapper);
          list.appendChild(li);
        });
      });
    }

    function draftPlayer(name) {
      const team = teams[currentTeamIndex];
      draftPicks[team].push(name);
      drafted.add(name);
      updateDraftBoard();
      nextTurn();
      renderPlayers();
    }

    function nextTurn() {
      if (!reverse) {
        currentTeamIndex++;
        if (currentTeamIndex >= teams.length) {
          currentTeamIndex = teams.length - 1;
          reverse = true;
          round++;
        }
      } else {
        currentTeamIndex--;
        if (currentTeamIndex < 0) {
          currentTeamIndex = 0;
          reverse = false;
          round++;
        }
      }

      if (round > totalRounds) {
        endDraft();
        return;
      }

      document.getElementById("currentTeam").textContent = teams[currentTeamIndex];
      document.getElementById("roundNum").textContent = round;
    }

    function updateDraftBoard() {
      const board = document.getElementById("draftBoard");
      board.innerHTML = "";
      teams.forEach(t => {
        const li = document.createElement("li");
        li.textContent = `${t}: ${draftPicks[t].join(", ")}`;
        board.appendChild(li);
      });
    }

    function undoLastPick() {
      const team = teams[currentTeamIndex];
      const last = draftPicks[team].pop();
      if (last) drafted.delete(last);
      updateDraftBoard();
      renderPlayers();
    }

    function endDraft() {
  const statsAPI = "https://api.sheety.co/8bc8ea9aa07e26b76e867fe4d92cee28/nbaPlayoffData/playerStats";

  fetch(statsAPI)
    .then(res => res.json())
    .then(data => {
      const playerStats = data.playerStats || [];
      window.latestStats = playerStats; // ‚úÖ Store globally

      const teamTotals = [];

      teams.forEach(team => {
        const picks = draftPicks[team];
        let totalPoints = 0;

        picks.forEach(name => {
          const stat = playerStats.find(p => p.player === name);
          if (stat && stat.points !== undefined) {
            totalPoints += Math.round(Number(stat.points));
          } else {
            console.warn("‚ö†Ô∏è No stat found for:", name);
          }
        });

        teamTotals.push({ team, totalPoints, picks });
      });

      localStorage.setItem("savedDraft", JSON.stringify({ draftPicks, teams }));
      teamTotals.sort((a, b) => b.totalPoints - a.totalPoints);
      showLeaderboard(teamTotals);
    })
    .catch(err => {
      alert("Failed to load stats.");
      console.error("Stats error:", err);
    });
}
    function viewSavedLeaderboard() {
  const saved = JSON.parse(localStorage.getItem("savedDraft"));
  if (!saved || !saved.teams || !saved.draftPicks) {
    alert("No saved draft found.");
    return;
  }

  fetch("https://api.sheety.co/8bc8ea9aa07e26b76e867fe4d92cee28/nbaPlayoffData/playerStats")
    .then(res => res.json())
    .then(data => {
      const playerStats = data.playerStats || [];
      window.latestStats = playerStats; // ‚úÖ Store globally

      const teamTotals = [];

      saved.teams.forEach(team => {
        const picks = saved.draftPicks[team];
        let totalPoints = 0;

        picks.forEach(name => {
          const stat = playerStats.find(p => p.player === name);
          if (stat && stat.points !== undefined) {
            totalPoints += Math.round(Number(stat.points));
          } else {
            console.warn("‚ö†Ô∏è No stat found for:", name);
          }
        });

        teamTotals.push({ team, totalPoints, picks });
      });

      teamTotals.sort((a, b) => b.totalPoints - a.totalPoints);
      showLeaderboard(teamTotals);
    })
    .catch(err => {
      alert("Failed to load stats.");
      console.error("Stats error:", err);
    });
}

   function showLeaderboard(teamTotals) {
  document.getElementById("draftUI").classList.remove("visible");
  document.getElementById("homeScreen").classList.remove("visible");
  document.getElementById("leaderboardScreen").classList.add("visible");

  const list = document.getElementById("leaderboardList");
  list.innerHTML = "";

  teamTotals.forEach((entry, index) => {
    const medal = index === 0 ? "ü•á" : index === 1 ? "ü•à" : index === 2 ? "ü•â" : "";
    const li = document.createElement("li");
    li.style.flexDirection = "column";
    li.style.alignItems = "flex-start";

    const header = document.createElement("div");
    header.style.display = "flex";
    header.style.justifyContent = "space-between";
    header.style.alignItems = "center";
    header.style.width = "100%";

    const label = document.createElement("strong");
    label.textContent = `${medal} ${entry.team} ‚Äî ${entry.totalPoints} pts`;

    const toggleBtn = document.createElement("button");
    toggleBtn.textContent = "View Players";
    toggleBtn.style.width = "100px";
    toggleBtn.style.padding = "6px 10px";
    toggleBtn.style.background = "#2980b9";
    toggleBtn.style.color = "#fff";
    toggleBtn.style.border = "none";
    toggleBtn.style.borderRadius = "5px";
    toggleBtn.style.cursor = "pointer";
    toggleBtn.style.fontSize = "0.9rem";

    header.appendChild(label);
    header.appendChild(toggleBtn);
    li.appendChild(header);

    const playerList = document.createElement("ul");
    playerList.style.marginTop = "8px";
    playerList.style.display = "none";

    entry.picks.forEach(player => {
      const stat = window.latestStats?.find(p => p.player === player);
      const pts = stat ? Math.round(stat.points) : 0;
      const eliminated = stat?.eliminated?.toLowerCase() === "yes";

      const detail = document.createElement("li");
      detail.textContent = `${eliminated ? "‚ùå " : ""}${player} - ${pts} pts`;
      detail.style.marginLeft = "16px";
      detail.style.fontSize = "0.95rem";
      if (eliminated) {
        detail.style.opacity = "0.6";
        detail.style.fontStyle = "italic";
      }
      playerList.appendChild(detail);
    });

    toggleBtn.onclick = () => {
      const visible = playerList.style.display === "block";
      playerList.style.display = visible ? "none" : "block";
      toggleBtn.textContent = visible ? "View Players" : "Hide Players";
    };

    li.appendChild(playerList);
    list.appendChild(li);
  });
}


  </script>

</body>
</html>
