<!DOCTYPE html>
<html>
  <head>
    <title>DropScore Player Viewer</title>
    <style>
      body {
        font-family: sans-serif;
        background-color: #0e1a2b;
        color: white;
        padding: 2rem;
      }
      h1 {
        color: #f44336;
      }
      ul {
        list-style: none;
        padding: 0;
      }
      li {
        background-color: #1f2f47;
        margin-bottom: 10px;
        padding: 10px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .player-info {
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }
      .player-info img {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        object-fit: cover;
      }
      #previousDrafts ul {
        padding-left: 1rem;
      }
      ol.leaderboard li {
        background-color: #26394d;
        font-size: 1.1rem;
        padding: 8px 12px;
        border-left: 5px solid gold;
      }
      ol.leaderboard li:nth-child(1)::before {
        content: "ü•á ";
      }
      ol.leaderboard li:nth-child(2)::before {
        content: "ü•à ";
      }
      ol.leaderboard li:nth-child(3)::before {
        content: "ü•â ";
      }
    </style>
  </head>
  <body>
    <div id="welcomeScreen">
      <h1>üèÄ Welcome to DropScore</h1>
      <p>
        Draft NBA playoff players in a snake-style fantasy draft. Track points
        and see who wins!
      </p>
      <button onclick="startApp()">Start New Draft</button>
      <button onclick="viewPreviousDraft()">View Previous Drafts</button>
    </div>

    <div id="createLeague" style="display: none; margin-bottom: 2rem">
      <h2>Create a League</h2>
      <ol>
        <li><strong>Step 1:</strong> Name your league</li>
        <li><strong>Step 2:</strong> Choose how many teams are drafting</li>
        <li><strong>Step 3:</strong> Begin your draft and track points!</li>
      </ol>
      <label for="leagueName">League Name:</label>
      <input
        type="text"
        id="leagueName"
        placeholder="Enter your league name"
      /><br /><br />
      <label for="totalRounds">Total Draft Rounds:</label>
      <input type="number" id="totalRounds" min="1" max="20" value="5" />
      <br /><br />
      <button onclick="proceedToTeamSetup()">Next</button>
    </div>

    <div id="mainApp" style="display: none">
      <h1>NBA Playoff Players</h1>
      <div id="teamSetup">
        <label for="teamCount">How many teams are drafting? (2-12)</label>
        <input type="number" id="teamCount" min="2" max="12" value="2" />
        <button onclick="setupTeams()">Next</button>
      </div>
      <div id="teamNameInputs" style="margin-top: 1rem"></div>
      <div id="draftControls" style="display: none; margin-top: 2rem">
        <h2>
          Round <span id="currentRound">1</span> - Current Turn:
          <span id="currentTeam"></span>
        </h2>
        <input
          type="text"
          id="playerSearch"
          placeholder="Search players..."
          oninput="renderPlayers(allPlayers)"
          style="margin-bottom: 1rem; padding: 0.5rem; width: 100%"
        />
        <ul id="playerList"></ul>
        <h3>Draft Board</h3>
        <ul id="draftBoard"></ul>
      </div>
    </div>

    <div id="previousDrafts" style="display: none"></div>

    <audio
      id="winnerSound"
      src="https://www.soundjay.com/human/applause-8.mp3"
      preload="auto"
    ></audio>

    <script>
      const API_URL =
        "https://api.sheety.co/8bc8ea9aa07e26b76e867fe4d92cee28/nbaPlayoffData/sheet1";
      let teams = [],
        draftPicks = {},
        currentIndex = 0,
        reverse = false,
        round = 1,
        allPlayers = [];
      let totalRounds = 5;
      let draftedPlayerNames = new Set();

      function startApp() {
        document.getElementById("welcomeScreen").style.display = "none";
        document.getElementById("createLeague").style.display = "block";
      }

      function proceedToTeamSetup() {
        const leagueName = document.getElementById("leagueName").value.trim();
        if (!leagueName) return alert("Please enter a league name.");
        totalRounds = parseInt(document.getElementById("totalRounds").value);
        document.getElementById("createLeague").style.display = "none";
        document.getElementById("mainApp").style.display = "block";
      }

      function setupTeams() {
        document.getElementById("teamSetup").style.display = "none";
        const count = parseInt(document.getElementById("teamCount").value);
        if (count < 2 || count > 12)
          return alert("Choose between 2 and 12 teams.");
        const container = document.getElementById("teamNameInputs");
        container.innerHTML = "<h2>Enter Team Names</h2>";
        for (let i = 0; i < count; i++) {
          container.innerHTML += `<input type='text' placeholder='Team ${
            i + 1
          }' id='team${i}' /><br/>`;
        }
        container.innerHTML += `<br><br><strong>Randomized Draft Order:</strong><ul id='draftOrderList'></ul><button onclick='startDraft()'>Start Draft</button>`;
      }

      function startDraft() {
        const inputElements = document.querySelectorAll(
          "#teamNameInputs input"
        );
        teams = Array.from(inputElements).map(
          (input) => input.value.trim() || input.placeholder
        );
        draftPicks = {};
        teams.forEach((team) => (draftPicks[team] = []));
        teams.sort(() => Math.random() - 0.5);
        draftedPlayerNames.clear();

        const orderList = document.getElementById("draftOrderList");
        orderList.innerHTML = "";
        teams.forEach((team, index) => {
          const li = document.createElement("li");
          li.textContent = `#${index + 1}: ${team}`;
          orderList.appendChild(li);
        });

        document.getElementById("teamNameInputs").style.display = "none";
        document.getElementById("draftControls").style.display = "block";

        const endBtn = document.createElement("button");
        endBtn.id = "endDraftBtn";
        endBtn.textContent = "End Draft";
        Object.assign(endBtn.style, {
          position: "fixed",
          bottom: "20px",
          right: "20px",
          backgroundColor: "red",
          color: "white",
          border: "none",
          padding: "10px 16px",
          borderRadius: "6px",
          fontSize: "16px",
          cursor: "pointer",
        });
        endBtn.onclick = endDraft;
        document.body.appendChild(endBtn);

        const undoBtn = document.createElement("button");
        undoBtn.textContent = "Undo Last Pick";
        undoBtn.style.marginLeft = "1rem";
        undoBtn.onclick = undoLastPick;
        document.getElementById("draftControls").appendChild(undoBtn);

        document.getElementById("currentTeam").textContent =
          teams[currentIndex];
        fetchPlayers();
      }

      function fetchPlayers() {
        fetch(API_URL)
          .then((res) => res.json())
          .then((data) => {
            allPlayers = data.sheet1;
            renderPlayers(allPlayers);
          });
      }

      function renderPlayers(players) {
        const searchQuery =
          document.getElementById("playerSearch")?.value?.toLowerCase() || "";
        const list = document.getElementById("playerList");
        list.innerHTML = "";
        players.sort((a, b) => a.team.localeCompare(b.team));
        players.forEach((player) => {
          if (
            player.eliminated ||
            draftedPlayerNames.has(player.playerName) ||
            !player.playerName.toLowerCase().includes(searchQuery)
          )
            return;

          const li = document.createElement("li");
          const infoDiv = document.createElement("div");
          infoDiv.className = "player-info";

          const img = document.createElement("img");
          img.src = `https://cdn.nba.com/headshots/nba/latest/260x190/${player.playerName.replace(
            /[^a-zA-Z]/g,
            ""
          )}.png`;
          img.alt = player.playerName;
          img.onerror = () => {
            img.src =
              "https://cdn.nba.com/headshots/nba/latest/260x190/fallback.png";
          };

          const text = document.createElement("span");
          text.textContent = `${player.playerName} | ${player.team} | Points: ${player.points}`;

          infoDiv.appendChild(img);
          infoDiv.appendChild(text);

          const btn = document.createElement("button");
          btn.textContent = "Draft";
          btn.onclick = () => {
            const currentTeam = teams[currentIndex];
            draftPicks[currentTeam].push(player.playerName);
            draftedPlayerNames.add(player.playerName);
            li.remove();
            updateDraftBoard();
            nextTurn();
          };
          li.appendChild(infoDiv);
          li.appendChild(btn);
          list.appendChild(li);
        });
      }

      function updateDraftBoard() {
        const board = document.getElementById("draftBoard");
        board.innerHTML = "";
        for (const team of teams) {
          const li = document.createElement("li");
          li.textContent = `${team}: ${draftPicks[team].join(", ")}`;
          board.appendChild(li);
        }
      }

      function nextTurn() {
        if (!reverse) {
          currentIndex++;
          if (currentIndex >= teams.length) {
            currentIndex = teams.length - 1;
            reverse = true;
            round++;
          }
        } else {
          currentIndex--;
          if (currentIndex < 0) {
            currentIndex = 0;
            reverse = false;
            round++;
          }
        }
        if (round > totalRounds) return endDraft();
        document.getElementById("currentRound").textContent = round;
        document.getElementById("currentTeam").textContent =
          teams[currentIndex];
      }

      function undoLastPick() {
        const currentTeam = teams[currentIndex];
        const lastPick = draftPicks[currentTeam].pop();
        if (lastPick) {
          draftedPlayerNames.delete(lastPick);
          updateDraftBoard();
          renderPlayers(allPlayers);
        }
      }

      function endDraft() {
        const leagueName = document.getElementById("leagueName").value.trim();
        const savedDrafts = JSON.parse(
          localStorage.getItem("allDrafts") || "[]"
        );
        const newDraft = {
          id: Date.now(),
          leagueName,
          teams,
          draftPicks,
          allPlayers,
        };
        if (savedDrafts.length >= 5) savedDrafts.shift();
        savedDrafts.push(newDraft);
        localStorage.setItem("allDrafts", JSON.stringify(savedDrafts));
        document.getElementById("endDraftBtn").style.display = "none";
        document.getElementById("draftControls").style.display = "none";

        const summary = document.createElement("div");
        summary.style.padding = "2rem";
        summary.innerHTML = "<h2>Draft Complete</h2>";
        document.getElementById("winnerSound").play();

        const teamScores = teams
          .map((team) => {
            const players = draftPicks[team];
            const totalPoints = players.reduce((sum, name) => {
              const player = allPlayers.find((p) => p.playerName === name);
              return sum + (player ? player.points : 0);
            }, 0);
            return { team, players, totalPoints };
          })
          .sort((a, b) => b.totalPoints - a.totalPoints);

        summary.innerHTML += "<h3>üèÜ Leaderboard</h3>";
        const leaderboard = document.createElement("ol");
        leaderboard.className = "leaderboard";
        teamScores.forEach(({ team, totalPoints }) => {
          const li = document.createElement("li");
          li.innerHTML = `<strong>${team}</strong> - ${totalPoints} pts`;
          leaderboard.appendChild(li);
        });
        summary.appendChild(leaderboard);

        const rosterTitle = document.createElement("h3");
        rosterTitle.textContent = "üìã Final Rosters";
        summary.appendChild(rosterTitle);

        const ul = document.createElement("ul");
        ul.style.listStyle = "none";
        teamScores.forEach(({ team, players, totalPoints }) => {
          const li = document.createElement("li");
          li.style.marginBottom = "10px";
          li.innerHTML = `<strong>${team}</strong> (${totalPoints} pts): ${players.join(
            ", "
          )}`;
          ul.appendChild(li);
        });
        summary.appendChild(ul);

        const homeBtn = document.createElement("button");
        homeBtn.textContent = "Return to Home";
        homeBtn.style.marginTop = "1rem";
        homeBtn.onclick = () => location.reload();
        summary.appendChild(homeBtn);

        document.getElementById("mainApp").innerHTML = "";
        document.getElementById("mainApp").appendChild(summary);
      }

      function viewPreviousDraft() {
        const container = document.getElementById("previousDrafts");
        container.innerHTML = "<h2>üèÖ Previous Draft Leaderboards</h2>";

        let drafts = JSON.parse(localStorage.getItem("allDrafts") || "[]");

        if (drafts.length === 0) {
          container.innerHTML += "<p>No previous drafts found.</p>";
        } else {
          drafts.reverse().forEach((draft) => {
            const section = document.createElement("section");
            section.style.marginBottom = "2rem";

            const header = document.createElement("div");
            header.style.display = "flex";
            header.style.justifyContent = "space-between";
            header.style.alignItems = "center";
            header.style.gap = "1rem";

            const title = document.createElement("h3");
            title.textContent = draft.leagueName;
            header.appendChild(title);

            const downloadBtn = document.createElement("button");
            downloadBtn.textContent = "‚¨áÔ∏è Download CSV";
            downloadBtn.style.background = "#2980b9";
            downloadBtn.style.color = "#fff";
            downloadBtn.style.border = "none";
            downloadBtn.style.padding = "4px 8px";
            downloadBtn.style.borderRadius = "5px";
            downloadBtn.style.cursor = "pointer";
            downloadBtn.onclick = () => downloadDraftCSV(draft);
            header.appendChild(downloadBtn);

            const deleteBtn = document.createElement("button");
            deleteBtn.textContent = "üóëÔ∏è Delete";
            deleteBtn.style.background = "#c0392b";
            deleteBtn.style.color = "#fff";
            deleteBtn.style.border = "none";
            deleteBtn.style.padding = "4px 8px";
            deleteBtn.style.borderRadius = "5px";
            deleteBtn.style.cursor = "pointer";
            deleteBtn.onclick = () => {
              const confirmDelete = confirm(
                `Are you sure you want to delete the draft "${draft.leagueName}"? This cannot be undone.`
              );
              if (confirmDelete) {
                drafts = drafts.filter((d) => d.id !== draft.id);
                localStorage.setItem(
                  "allDrafts",
                  JSON.stringify(drafts.reverse())
                ); // reverse back before saving
                viewPreviousDraft();
              }
            };
            header.appendChild(deleteBtn);

            section.appendChild(header);

            const scores = draft.teams
              .map((team) => {
                const players = draft.draftPicks[team];
                const totalPoints = players.reduce((sum, name) => {
                  const player = draft.allPlayers.find(
                    (p) => p.playerName === name
                  );
                  return sum + (player ? player.points : 0);
                }, 0);
                return { team, players, totalPoints };
              })
              .sort((a, b) => b.totalPoints - a.totalPoints);

            const leaderboard = document.createElement("ol");
            leaderboard.className = "leaderboard";
            scores.forEach(({ team, totalPoints }) => {
              const li = document.createElement("li");
              li.innerHTML = `<strong>${team}</strong> - ${totalPoints} pts`;
              leaderboard.appendChild(li);
            });

            section.appendChild(leaderboard);

            const rosterList = document.createElement("ul");
            scores.forEach(({ team, players }) => {
              const li = document.createElement("li");
              li.innerHTML = `<strong>${team}</strong>: ${players.join(", ")}`;
              rosterList.appendChild(li);
            });
            section.appendChild(rosterList);

            container.appendChild(section);
          });
        }

        // ‚¨áÔ∏è Export Button
        const exportBtn = document.createElement("button");
        exportBtn.textContent = "‚¨áÔ∏è Export Drafts (.json)";
        exportBtn.style.marginTop = "1rem";
        exportBtn.onclick = () => {
          const allDrafts = localStorage.getItem("allDrafts");
          const blob = new Blob([allDrafts], { type: "application/json" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "dropScore_drafts_backup.json";
          a.click();
          URL.revokeObjectURL(url);
        };
        container.appendChild(exportBtn);

        // ‚¨ÜÔ∏è Import Input
        const importLabel = document.createElement("label");
        importLabel.textContent = "‚¨ÜÔ∏è Import Drafts (.json)";
        importLabel.style.display = "block";
        importLabel.style.marginTop = "1rem";

        const importInput = document.createElement("input");
        importInput.type = "file";
        importInput.accept = ".json";
        importInput.onchange = (e) => {
          const file = e.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = (event) => {
            try {
              const imported = JSON.parse(event.target.result);
              if (Array.isArray(imported)) {
                localStorage.setItem("allDrafts", JSON.stringify(imported));
                alert("Drafts imported successfully! Refreshing...");
                viewPreviousDraft();
              } else {
                alert("Invalid JSON format.");
              }
            } catch (err) {
              alert("Error reading file: " + err.message);
            }
          };
          reader.readAsText(file);
        };

        container.appendChild(importLabel);
        container.appendChild(importInput);

        // ‚è™ Return Home
        const homeBtn = document.createElement("button");
        homeBtn.textContent = "Return to Home";
        homeBtn.style.marginTop = "1rem";
        homeBtn.onclick = () => {
          container.style.display = "none";
          document.getElementById("welcomeScreen").style.display = "block";
        };
        container.appendChild(homeBtn);

        document.getElementById("welcomeScreen").style.display = "none";
        container.style.display = "block";
      }
      function downloadDraftCSV(draft) {
        let csv = `League: ${draft.leagueName}\n\nTeam,Players,Total Points\n`;

        draft.teams.forEach((team) => {
          const players = draft.draftPicks[team];
          const totalPoints = players.reduce((sum, name) => {
            const player = draft.allPlayers.find((p) => p.playerName === name);
            return sum + (player ? player.points : 0);
          }, 0);
          csv += `"${team}","${players.join(", ")}",${totalPoints}\n`;
        });

        const blob = new Blob([csv], { type: "text/csv" });
        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = `${draft.leagueName.replace(/\s+/g, "_")}_draft.csv`;
        a.click();
        URL.revokeObjectURL(url);
      }
    </script>
  </body>
</html>
