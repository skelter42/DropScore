<!DOCTYPE html>
<html lang="en">
<head>


  <meta charset="UTF-8" />
  <title>DropScore Draft</title>



  <!-- âœ… Styles -->
  <style>
    body {
  
      font-family: Arial, sans-serif;
      background: #0e1a2b;
      color: white;
      padding: 2rem;
      margin: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h1, h2 {
      color: #f44336;
      text-align: center;
    }
    .screen { display: none; width: 100%; max-width: 600px; }
    .visible { display: block; }
    input, button {
      width: 100%;
      padding: 0.75rem;
      margin: 0.5rem 0;
      border: none;
      border-radius: 6px;
      font-size: 1rem;
    }
    button {
      background: #3498db;
      color: white;
      cursor: pointer;
    }
    ul {
      list-style: none;
      padding: 0;
    }
    li {
      background: #1f2f47;
      margin: 6px 0;
      padding: 10px;
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
  /* Back Button for Leaderboard */
  #backBtnLeaderboard,
  #backBtnDraft,
  #backBtnContest {
    position: absolute;
    top: 10px;
    left: 10px;
    padding: 4px 8px;
    font-size: 1rem;
    background: #2c3e50;
    color: white;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    z-index: 10;
    width: 32px;
    height: 32px;
    line-height: 24px;
    text-align: center;
  }
#backBtnMyEntries {
  position: absolute;
  top: 10px;
  left: 10px;
  padding: 4px 8px;
  font-size: 1rem;
  background: #2c3e50;
  color: white;
  border: none;
  border-radius: 50%;
  cursor: pointer;
  z-index: 10;
  width: 32px;
  height: 32px;
  line-height: 24px;
  text-align: center;
}
#backBtnExposures {
  position: absolute;
  top: 10px;
  left: 10px;
  padding: 4px 8px;
  font-size: 1rem;
  background: #2c3e50;
  color: white;
  border: none;
  border-radius: 50%;
  cursor: pointer;
  z-index: 10;
  width: 32px;
  height: 32px;
  line-height: 24px;
  text-align: center;
}
  </style>
</head>

<body>

  
<!-- Standalone Login Screen -->
<div id="loginScreen" class="screen visible">
<h1 style="text-align: center;">ğŸ† DropScore: Survivor-Style NBA Playoff Fantasy</h1>
<p style="font-size: 1rem; max-width: 600px; margin: 10px auto; color: #ccc; text-align: center;">
  Draft 10 players. Earn points while their teams stay alive. Once theyâ€™re eliminated, they stop scoring. Can your roster survive the playoffs?
</p>
  <div id="loginForm">
    <input type="text" id="usernameInput" placeholder="Username (for registration)" />
    <input type="email" id="emailInput" placeholder="Email" />
    <input type="password" id="passwordInput" placeholder="Password" />
  
 <button onclick="registerUser()">Register</button>
<button onclick="loginUser()">Login</button>
<button onclick="continueAsGuest()" style="background:#7f8c8d;">ğŸ‘¤ Continue as Guest</button>
  </div>
</div>

<div id="mainMenu" class="screen">
<h2 style="text-align: center;">ğŸ† DropScore: Survivor-Style NBA Playoff Fantasy</h2>
<p style="font-size: 1rem; max-width: 600px; margin: 10px auto; color: #ccc; text-align: center;">
  Draft 10 players. Earn points while their teams stay alive. Once theyâ€™re eliminated, they stop scoring. Can your roster survive the playoffs?
</p>
<span id="usernameDisplay" style="display: none;"></span>
  <button onclick="goToDraft()">ğŸ€ Enter Lineup</button>
  <button onclick="goToLeaderboard()">ğŸ“Š View Leaderboard</button>
  <button onclick="goToExposures()">ğŸŒ Global Exposures</button>
  <button onclick="goToContestDetails()">ğŸ“ Contest Details</button>
  <button onclick="goToMyEntries()">ğŸ™‹ My Entries</button>
  <button onclick="logoutUser()" style="background:#c0392b;">ğŸšª Log Out</button>
</div>

  
<div id="contestScreen" class="screen">
  <button onclick="backToHome()" id="backBtnContest">â†</button>
  <h2>ğŸ“ Contest Details</h2>
    <!-- âœ… Google AdSense: Display during contest content -->
  <div style="margin: 12px 0;">
    <ins class="adsbygoogle"
         style="display:block"
         data-ad-client="ca-pub-5319541186981982"
         data-ad-slot="8095067697"
         data-ad-format="auto"
         data-full-width-responsive="true"></ins>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({});
    </script>
  </div>
<p>
  <strong>DropScore</strong> brings <em>Survivor</em> to fantasy. Simply draft <strong>10 players</strong> from any team and you earn however many fantasy points they accrue throughout the playoffs.
</p>
<p>
  You can play it safe with stars or go bold â€” if you think a play-in team is going to make a run, make sure to include a player or two!
  But beware: once your player is eliminated, they <strong>stop scoring points</strong> for your team.
</p>
  You can submit as many enteries as you want!
  
  You may enter a group code when drafting to join a specific group, or leave the field blank to be included in the public pool. All group entries will also appear on the public leaderboard.

<h3>ğŸ“Š Scoring System</h3>
<ul>
  <li>Points: <strong>1</strong></li>
  <li>Assists: <strong>1.5</strong></li>
  <li>Rebounds: <strong>1.25</strong></li>
  <li>Blocks: <strong>2</strong></li>
  <li>Steals: <strong>2</strong></li>
  <li>Turnovers: <strong>-0.5</strong></li>
</ul>
</div>



<div id="liveLeaderboardScreen" class="screen">
  <button onclick="backToHome()" id="backBtnLeaderboard">â†</button>
  <h2>ğŸ“Š Live Leaderboard</h2>
    <!-- âœ… Google AdSense: Display on leaderboard screen -->
  <div style="margin: 12px 0;">
    <ins class="adsbygoogle"
         style="display:block"
         data-ad-client="ca-pub-5319541186981982"
         data-ad-slot="8095067697"
         data-ad-format="auto"
         data-full-width-responsive="true"></ins>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({});
    </script>
  </div>



  <!-- ğŸ” Group code input + switch -->
  <input type="text" id="groupCodeViewInput" placeholder="Enter group code (or leave blank for public)" />
  <button onclick="loadLeaderboardByGroup()" style="margin-top: 6px;">ğŸ”„ View Group</button>
  <p id="currentGroupLabel" style="font-size: 0.9rem; margin-top: 6px; font-style: italic; color: #ccc;">
    Showing: <strong>public</strong>
  </p>

  <ul id="liveLeaderboardList"></ul>
</div>

<div id="myEntriesScreen" class="screen">
  <button onclick="backToHome()" id="backBtnMyEntries">â†</button>
  <h2>ğŸ™‹ My Draft Entries</h2>
  <ul id="myEntriesList"></ul>
</div>
  
<div id="exposuresScreen" class="screen">
  <button onclick="backToHome()" id="backBtnExposures">â†</button>
  <h2>ğŸŒ Global Exposures</h2>
  <!-- âœ… Google AdSense: Display on Global Exposures screen -->
<div style="margin: 12px 0;">
  <ins class="adsbygoogle"
       style="display:block"
       data-ad-client="ca-pub-5319541186981982"
       data-ad-slot="8095067697"
       data-ad-format="auto"
       data-full-width-responsive="true"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>
  <ul id="exposuresList">Loading exposures...</ul>
</div>


<div id="draftScreen" class="screen">
  <button onclick="backToHome()" id="backBtnDraft">â†</button>
  <h2>Pick your top 10 players</h2>
    <h3>Your Picks</h3>
    <ul id="draftBoard"></ul>
   <label for="groupCodeDraft" style="margin-top: 10px; display: block;">Optional Group Code:</label>
<input type="text" id="groupCodeDraft" placeholder="Leave blank to enter public group" oninput="updateGroupLabel()" />

<p id="groupIndicator" style="font-size: 0.9rem; font-style: italic; margin-top: 4px; color: #ccc;">
  
</p>

    
  <!-- âœ… Undo Draft Pick Button -->
  <button id="undoButton" onclick="undoLastPick()" style="background-color:#e67e22; color:white; margin-top:10px;">
    â†©ï¸ Undo Last Pick
  </button>


    <input type="text" id="searchInput" placeholder="Search by player or team..." oninput="renderPlayers()" />
    <ul id="playerList">Loading players...</ul>
  </div>

  <div id="leaderboardScreen" class="screen">
    <h2>ğŸ† Your Draft Result</h2>
    <ul id="leaderboardList"></ul>
<button onclick="location.reload()">ğŸ  Return to Menu</button>
  </div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

  
  <script>
    
    const firebaseConfig = {
  apiKey: "AIzaSyAtfHUlUynmn86icD6yHcOfjPd4snKHmwY",
  authDomain: "dropscore-8ad6b.firebaseapp.com",
  projectId: "dropscore-8ad6b",
  storageBucket: "dropscore-8ad6b.firebasestorage.app",
  messagingSenderId: "223006355256",
  appId: "1:223006355256:web:d500f7b1c0d329d69c1bcd",
  measurementId: "G-DM5QL9DHS3"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();

 const teamNames = {
  ATL: "Atlanta Hawks",
  BOS: "Boston Celtics",
  BKN: "Brooklyn Nets",
  CHA: "Charlotte Hornets",
  CHI: "Chicago Bulls",
  CLE: "Cleveland Cavaliers",
  DAL: "Dallas Mavericks",
  DEN: "Denver Nuggets",
  DET: "Detroit Pistons",
  GSW: "Golden State Warriors",
  HOU: "Houston Rockets",
  IND: "Indiana Pacers",
  LAC: "LA Clippers",
  LAL: "Los Angeles Lakers",
  MEM: "Memphis Grizzlies",
  MIA: "Miami Heat",
  MIL: "Milwaukee Bucks",
  MIN: "Minnesota Timberwolves",
  NOP: "New Orleans Pelicans",
  NYK: "New York Knicks",
  OKC: "Oklahoma City Thunder",
  ORL: "Orlando Magic",
  PHI: "Philadelphia 76ers",
  PHX: "Phoenix Suns",
  POR: "Portland Trail Blazers",
  SAC: "Sacramento Kings",
  SAS: "San Antonio Spurs",
  TOR: "Toronto Raptors",
  UTA: "Utah Jazz",
  WAS: "Washington Wizards"
};
 

const teamLogos = {
  ATL: "https://cdn.nba.com/logos/nba/1610612737/primary/L/logo.svg",
  BOS: "https://cdn.nba.com/logos/nba/1610612738/primary/L/logo.svg",
  BKN: "https://cdn.nba.com/logos/nba/1610612751/primary/L/logo.svg",
  CHA: "https://cdn.nba.com/logos/nba/1610612766/primary/L/logo.svg",
  CHI: "https://cdn.nba.com/logos/nba/1610612741/primary/L/logo.svg",
  CLE: "https://cdn.nba.com/logos/nba/1610612739/primary/L/logo.svg",
  DAL: "https://cdn.nba.com/logos/nba/1610612742/primary/L/logo.svg",
  DEN: "https://cdn.nba.com/logos/nba/1610612743/primary/L/logo.svg",
  DET: "https://cdn.nba.com/logos/nba/1610612765/primary/L/logo.svg",
  GSW: "https://cdn.nba.com/logos/nba/1610612744/primary/L/logo.svg",
  HOU: "https://cdn.nba.com/logos/nba/1610612745/primary/L/logo.svg",
  IND: "https://cdn.nba.com/logos/nba/1610612754/primary/L/logo.svg",
  LAC: "https://cdn.nba.com/logos/nba/1610612746/primary/L/logo.svg",
  LAL: "https://cdn.nba.com/logos/nba/1610612747/primary/L/logo.svg",
  MEM: "https://cdn.nba.com/logos/nba/1610612763/primary/L/logo.svg",
  MIA: "https://cdn.nba.com/logos/nba/1610612748/primary/L/logo.svg",
  MIL: "https://cdn.nba.com/logos/nba/1610612749/primary/L/logo.svg",
  MIN: "https://cdn.nba.com/logos/nba/1610612750/primary/L/logo.svg",
  NOP: "https://cdn.nba.com/logos/nba/1610612740/primary/L/logo.svg",
  NYK: "https://cdn.nba.com/logos/nba/1610612752/primary/L/logo.svg",
  OKC: "https://cdn.nba.com/logos/nba/1610612760/primary/L/logo.svg",
  ORL: "https://cdn.nba.com/logos/nba/1610612753/primary/L/logo.svg",
  PHI: "https://cdn.nba.com/logos/nba/1610612755/primary/L/logo.svg",
  PHO: "https://cdn.nba.com/logos/nba/1610612756/primary/L/logo.svg",
  POR: "https://cdn.nba.com/logos/nba/1610612757/primary/L/logo.svg",
  SAC: "https://cdn.nba.com/logos/nba/1610612758/primary/L/logo.svg",
  SAS: "https://cdn.nba.com/logos/nba/1610612759/primary/L/logo.svg",
  TOR: "https://cdn.nba.com/logos/nba/1610612761/primary/L/logo.svg",
  UTA: "https://cdn.nba.com/logos/nba/1610612762/primary/L/logo.svg",
  WAS: "https://cdn.nba.com/logos/nba/1610612764/primary/L/logo.svg"
};

const playerAPI = "https://api.sheety.co/8bc8ea9aa07e26b76e867fe4d92cee28/nbaPlayoffData/draftPicks";
const statsAPI = "https://api.sheety.co/8bc8ea9aa07e26b76e867fe4d92cee28/nbaPlayoffData/playerStats";

let drafted = new Set();
let draftPicks = [];
let players = [];
let submissionInProgress = false;

function startDraft() {
  drafted = new Set();
  draftPicks = [];
  players = []; // âœ… Clear players list

  // Clear UI in case of leftovers
  const board = document.getElementById("draftBoard");
  const list = document.getElementById("playerList");
  if (board) board.innerHTML = "";
  if (list) list.innerHTML = "Loading players...";

  fetch(playerAPI)
    .then(res => res.json())
    .then(data => {
      players = data.draftPicks || [];
      renderPlayers(); // âœ… This sets up the buttons
    })
    .catch(err => {
      console.error("âš ï¸ Failed to load players:", err);
      alert("Failed to load player list.");
    });
}


function renderPlayers() {
  console.log("ğŸ” Rendering players...", players); // âœ… Add this line
  const list = document.getElementById("playerList");
  const search = (document.getElementById("searchInput")?.value || "").toLowerCase();
  list.innerHTML = "";

  const filtered = players.filter(p => {
    const name = p.player.toLowerCase();
    const team = p.team.toLowerCase();
    return !drafted.has(p.player) && (name.includes(search) || team.includes(search));
  });

  filtered.forEach(p => {
    const li = document.createElement("li");

    const wrapper = document.createElement("div");
    wrapper.style.display = "flex";
    wrapper.style.alignItems = "center";
    wrapper.style.justifyContent = "space-between";
    wrapper.style.width = "100%";

    const infoDiv = document.createElement("div");
    infoDiv.style.flexGrow = "1";

    const logo = teamLogos[p.team.toUpperCase()];
    infoDiv.innerHTML = logo
      ? `<img src="${logo}" style="height:20px;vertical-align:middle;margin-right:6px;"> ${p.player} (${p.team})`
      : `${p.player} (${p.team})`;

    const btn = document.createElement("button");
    btn.textContent = "Draft";
    btn.style.width = "80px";
    btn.style.marginLeft = "12px";
    btn.style.flexShrink = "0";
    btn.onclick = () => draftPlayer(p.player); // âœ… Button click

    wrapper.appendChild(infoDiv);
    wrapper.appendChild(btn);
    li.appendChild(wrapper);
    list.appendChild(li);
  });
}
function updateDraftBoard() {
  const board = document.getElementById("draftBoard");
  board.innerHTML = "";

  for (let i = 0; i < 10; i++) {
    const li = document.createElement("li");
    const playerName = draftPicks[i] || "___";
    li.textContent = `${i + 1}. ${playerName}`;
    board.appendChild(li);
  }
}


function draftPlayer(name) {
  if (draftPicks.length >= 10) return;

  draftPicks.push(name);
  drafted.add(name);
  updateDraftBoard();
  renderPlayers();

  if (draftPicks.length === 10) {
    setTimeout(() => {
      const confirmSubmit = confirm("You've picked 10 players. Submit your picks?");
      if (confirmSubmit) {
        endDraft(); // âœ… Proceed with submission
      } else {
        alert("You can still make changes before submitting.");
      }
    }, 200); // small delay for better UX
  }
}



async function endDraft() {
  if (submissionInProgress) {
    console.warn("âš ï¸ Draft already submitting... duplicate click ignored.");
    return;
  }

  // âŒ Block guest submissions
  if (window.currentEmail?.includes('@guest.local')) {
    alert("ğŸ‘¤ Guest users can't submit drafts. Please log in or register to save your entry.");
    return;
  }

  submissionInProgress = true;

  try {
    const groupInput = document.getElementById("groupCodeDraft");
    window.currentGroup = groupInput ? groupInput.value.trim() : "";
    const userGroup = window.currentGroup || "public";

    const leagueRes = await fetch("https://api.sheety.co/8bc8ea9aa07e26b76e867fe4d92cee28/nbaPlayoffData/leagues");
    const leagueData = await leagueRes.json();
    const existingEntries = leagueData.leagues || [];

    const userBase = window.currentUser;
    const matchingEntries = existingEntries.filter(entry =>
      (entry.group || "public").toLowerCase() === userGroup.toLowerCase() &&
      entry.leagueName.toLowerCase().startsWith(userBase.toLowerCase())
    );

    let label = userBase;
    if (matchingEntries.length > 0) {
      label = `${userBase} (${matchingEntries.length + 1})`;
    }

    const res = await fetch(statsAPI);
    const data = await res.json();
    const stats = data.playerStats || [];

    const leaderboard = document.getElementById("leaderboardList");
    leaderboard.innerHTML = "";

    let total = 0;
    draftPicks.forEach(name => {
      const stat = stats.find(p => p.player === name);
      const pts = stat ? parseFloat(stat.points).toFixed(2) : "0.00";
      const eliminated = stat?.eliminated?.toLowerCase() === "yes";
      const teamAbbr = stat?.team?.toUpperCase();
      const logo = teamLogos[teamAbbr];

      const li = document.createElement("li");
      li.innerHTML = `
        ${logo ? `<img src="${logo}" style="height:16px;margin-right:6px;">` : ""}
        ${eliminated ? "âŒ " : ""}${name} - ${pts} pts
      `;
      if (eliminated) {
        li.style.opacity = "0.6";
        li.style.fontStyle = "italic";
      }
      leaderboard.appendChild(li);
      total += parseFloat(pts);
    });

    const header = document.createElement("li");
    header.innerHTML = `<strong>ğŸ Total Points: ${total.toFixed(2)}</strong>`;
    header.style.marginBottom = "10px";
    leaderboard.insertBefore(header, leaderboard.firstChild);

    // âœ… Show results screen and scroll to top
    showScreen("leaderboardScreen");
    window.scrollTo({ top: 0, behavior: "smooth" });

    // âœ… Save entry
    const payload = {
      league: {
        leagueName: label,
        email: window.currentEmail,
        draftPicks: JSON.stringify(draftPicks),
        group: userGroup
      }
    };

    const postRes = await fetch("https://api.sheety.co/8bc8ea9aa07e26b76e867fe4d92cee28/nbaPlayoffData/leagues", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const result = await postRes.json();
    if (!postRes.ok) {
      alert("âš ï¸ Failed to save your draft. See console for details.");
    }

  } catch (err) {
    alert("âŒ Error fetching stats or saving draft.");
    console.error("ğŸ’¥ Error in endDraft():", err);
  }

  submissionInProgress = false;
}


async function loadLiveLeaderboard() {
  const leagueAPI = "https://api.sheety.co/8bc8ea9aa07e26b76e867fe4d92cee28/nbaPlayoffData/leagues";
  const statsAPI = "https://api.sheety.co/8bc8ea9aa07e26b76e867fe4d92cee28/nbaPlayoffData/playerStats";

  try {
    const [leagueRes, statsRes] = await Promise.all([
      fetch(leagueAPI),
      fetch(statsAPI)
    ]);

    const leagueData = await leagueRes.json();
    const statsData = await statsRes.json();

    const allEntries = leagueData.leagues || [];
    const playerStats = statsData.playerStats || [];

    // âœ… Show all groups if no filter is applied
    let entries;
    if (!window.currentGroup || window.currentGroup.toLowerCase() === "all") {
      entries = allEntries;
    } else {
      entries = allEntries.filter(entry =>
        (entry.group || "public").toLowerCase() === window.currentGroup.toLowerCase()
      );
    }

    const leaderboard = [];

    entries.forEach(entry => {
      const user = entry.leagueName;
      const picks = JSON.parse(entry.draftPicks);
      let totalPoints = 0;

      const fullRoster = picks.map(name => {
        const stat = playerStats.find(p => p.player === name);
        const points = stat?.points ? parseFloat(stat.points).toFixed(2) : "0.00";
        const eliminated = stat?.eliminated?.toLowerCase() === "yes";
        const teamAbbr = stat?.team?.toUpperCase();
        totalPoints += parseFloat(points);
        return {
          name,
          points,
          eliminated,
          teamAbbr
        };
      });

      leaderboard.push({ user, totalPoints: totalPoints.toFixed(2), fullRoster });
    });

    leaderboard.sort((a, b) => b.totalPoints - a.totalPoints);

    const list = document.getElementById("liveLeaderboardList");
    list.innerHTML = "";

    leaderboard.forEach((entry, index) => {
      const medal = index === 0 ? "ğŸ¥‡" : index === 1 ? "ğŸ¥ˆ" : index === 2 ? "ğŸ¥‰" : "";
      const li = document.createElement("li");
      li.style.flexDirection = "column";
      li.style.alignItems = "flex-start";

      const header = document.createElement("div");
      header.style.display = "flex";
      header.style.justifyContent = "space-between";
      header.style.alignItems = "center";
      header.style.width = "100%";

      const label = document.createElement("strong");
      label.textContent = `${medal} ${entry.user} â€” ${entry.totalPoints} pts`;

      const toggleBtn = document.createElement("button");
      toggleBtn.textContent = "View Players";
      toggleBtn.style.width = "100px";
      toggleBtn.style.padding = "6px 10px";
      toggleBtn.style.background = "#2980b9";
      toggleBtn.style.color = "#fff";
      toggleBtn.style.border = "none";
      toggleBtn.style.borderRadius = "5px";
      toggleBtn.style.cursor = "pointer";
      toggleBtn.style.fontSize = "0.9rem";

      header.appendChild(label);
      header.appendChild(toggleBtn);
      li.appendChild(header);

      const playerList = document.createElement("ul");
      playerList.style.marginTop = "8px";
      playerList.style.display = "none";

      entry.fullRoster.forEach(player => {
        const detail = document.createElement("li");
        const logo = teamLogos[player.teamAbbr];
        detail.innerHTML = `
          ${logo ? `<img src="${logo}" style="height:16px;margin-right:6px;">` : ""}
          ${player.eliminated ? "âŒ " : ""}${player.name} - ${player.points} pts
        `;
        if (player.eliminated) {
          detail.style.opacity = "0.6";
          detail.style.fontStyle = "italic";
        }
        detail.style.marginLeft = "16px";
        detail.style.fontSize = "0.95rem";
        playerList.appendChild(detail);
      });

      toggleBtn.onclick = () => {
        const visible = playerList.style.display === "block";
        playerList.style.display = visible ? "none" : "block";
        toggleBtn.textContent = visible ? "View Players" : "Hide Players";
      };

      li.appendChild(playerList);
      list.appendChild(li);
    });

  } catch (err) {
    console.error("âŒ Error loading live leaderboard:", err);
    alert("Failed to load live leaderboard.");
  }
}
async function calculatePlayerExposures() {
  const res = await fetch("https://api.sheety.co/8bc8ea9aa07e26b76e867fe4d92cee28/nbaPlayoffData/leagues");
  const data = await res.json();
  const entries = data.leagues || [];

  const exposureMap = {};
  const totalEntries = entries.length;

  entries.forEach(entry => {
    const picks = JSON.parse(entry.draftPicks);
    picks.forEach(player => {
      exposureMap[player] = (exposureMap[player] || 0) + 1;
    });
  });

  // Convert to percentages
  const exposures = Object.entries(exposureMap).map(([player, count]) => {
    return {
      player,
      count,
      percent: ((count / totalEntries) * 100).toFixed(1) + "%"
    };
  });

  exposures.sort((a, b) => b.count - a.count);

  return exposures;
}

    
function registerUser() {
  const username = document.getElementById("usernameInput").value.trim();
  const email = document.getElementById("emailInput").value;
  const password = document.getElementById("passwordInput").value;

  if (!username) {
    alert("Please enter a username.");
    return;
  }

  auth.createUserWithEmailAndPassword(email, password)
    .then(userCred => {
      alert("âœ… Account created and logged in!");
      window.currentUser = username;
      window.currentEmail = email;

      // Hide login and show main menu
      document.getElementById("loginForm").style.display = "none";
      document.getElementById("loginScreen").classList.remove("visible");

      document.getElementById("usernameDisplay").textContent = window.currentUser;
      showScreen("mainMenu");
    })
    .catch(err => {
      console.error("âŒ Registration error:", err);
      alert(err.message);
    });
}

function loginUser() {
  const email = document.getElementById("emailInput").value;
  const password = document.getElementById("passwordInput").value;

  auth.signInWithEmailAndPassword(email, password)
    .then(userCred => {
      alert("âœ… Logged in!");
      window.currentUser = email.split("@")[0]; // fallback if no username stored
      window.currentEmail = email;

      // Hide login and show main menu
      document.getElementById("loginForm").style.display = "none";
      document.getElementById("loginScreen").classList.remove("visible");

      document.getElementById("usernameDisplay").textContent = window.currentUser;
      showScreen("mainMenu");
    })
    .catch(err => {
      console.error("âŒ Login error:", err);
      alert(err.message);
    });
}

function showScreen(id) {
  // Hide all screens
  document.querySelectorAll(".screen").forEach(screen => screen.classList.remove("visible"));

  // Show the target screen
  const target = document.getElementById(id);
  target.classList.add("visible");

  // âœ… Load AdSense ONLY on these content-rich pages
  const adSafeScreens = [
    "contestScreen",        // ğŸ“ Contest Details
    "myEntriesScreen",      // ğŸ™‹ My Entries
    "exposuresScreen",      // ğŸŒ Global Exposures
    "liveLeaderboardScreen" // ğŸ“Š Live Leaderboard âœ… NEW
  ];

  if (adSafeScreens.includes(id)) {
    loadAdSenseScriptOnce();

    setTimeout(() => {
      try {
        (adsbygoogle = window.adsbygoogle || []).push({});
      } catch (e) {
        console.warn("ğŸ›‘ Lazy AdSense push failed:", e);
      }
    }, 300);
  }
}







function goToLeaderboard() {
  // ğŸ”’ Unlocks on April 15, 2025 at 7:00 PM EST (11:00 PM UTC)
  const unlockTime = new Date("2025-04-15T23:30:00Z");
  const now = new Date();

  if (now < unlockTime) {
    alert("â³ The leaderboard will be available on April 15 at 7:30 PM EST.");
    return;
  }

  // âœ… Load leaderboard like normal after unlock
  showScreen("liveLeaderboardScreen");
  loadLiveLeaderboard();
}


function goToContestDetails() {
  showScreen("contestScreen");
}
    
function undoLastPick() {
  if (draftPicks.length === 0) {
    alert("No picks to undo!");
    return;
  }

  const removed = draftPicks.pop();
  drafted.delete(removed);

  updateDraftBoard();
  renderPlayers();
}

 function goToExposures() {
  // Unlock on April 15, 2025 at 7:00 PM EST (11:00 PM UTC)
  const unlockTime = new Date("2025-04-15T23:30:00Z");
  const now = new Date();

  if (now < unlockTime) {
    alert("â³ Global exposures will be available on April 15 at 7:30 PM EST.");
    return;
  }

  showScreen("exposuresScreen");
  loadExposures();
}


async function loadExposures() {
  const leagueRes = await fetch("https://api.sheety.co/8bc8ea9aa07e26b76e867fe4d92cee28/nbaPlayoffData/leagues");
  const statsRes = await fetch("https://api.sheety.co/8bc8ea9aa07e26b76e867fe4d92cee28/nbaPlayoffData/playerStats");

  const leagueData = await leagueRes.json();
  const statsData = await statsRes.json();

  const entries = leagueData.leagues || [];
  const stats = statsData.playerStats || [];

  const exposureMap = {};
  const totalEntries = entries.length;

  entries.forEach(entry => {
    const picks = JSON.parse(entry.draftPicks);
    picks.forEach(player => {
      exposureMap[player] = (exposureMap[player] || 0) + 1;
    });
  });

  const exposures = Object.entries(exposureMap).map(([player, count]) => {
    const stat = stats.find(p => p.player === player);
    const eliminated = stat?.eliminated?.toLowerCase() === "yes";
    const teamAbbr = stat?.team?.toUpperCase();
    const logo = teamLogos[teamAbbr];

    return {
      player,
      count,
      percent: ((count / totalEntries) * 100).toFixed(1),
      eliminated,
      logo
    };
  });

  exposures.sort((a, b) => b.count - a.count);

  const list = document.getElementById("exposuresList");
  list.innerHTML = "";

  exposures.forEach(row => {
    const li = document.createElement("li");
    li.style.display = "flex";
    li.style.justifyContent = "space-between";
    li.style.alignItems = "center";

    li.innerHTML = `
      <div style="display: flex; align-items: center;">
        ${row.logo ? `<img src="${row.logo}" style="height:16px;margin-right:6px;">` : ""}
        ${row.eliminated ? "âŒ " : ""}${row.player}
      </div>
      <div style="font-weight: bold;">${row.percent}% (${row.count})</div>
    `;

    if (row.eliminated) {
      li.style.opacity = "0.6";
      li.style.fontStyle = "italic";
    }

    list.appendChild(li);
  });
}



function logoutUser() {
  auth.signOut().then(() => {
    // Clear user info
    window.currentUser = null;
    window.currentEmail = null;
    window.currentGroup = null;

    // Reset screens
    showScreen("loginScreen");
    document.getElementById("loginForm").style.display = "block";

    // Clear input fields (optional)
    document.getElementById("usernameInput").value = "";
    document.getElementById("emailInput").value = "";
    document.getElementById("passwordInput").value = "";
    document.getElementById("groupCodeInput").value = "";
  }).catch(err => {
    console.error("âŒ Error logging out:", err);
    alert("Logout failed.");
  });
}
function loadLeaderboardByGroup() {
  // 1. Read group code from the input field
  const input = document.getElementById("groupCodeViewInput").value.trim();

  // 2. Update global group reference
  window.currentGroup = input || "";

  // 3. Update label text
  const label = document.getElementById("currentGroupLabel");
  label.innerHTML = `Showing: <strong>${window.currentGroup || "all groups"}</strong>`;

  // 4. Reload leaderboard
  loadLiveLeaderboard();
}
function loadMyEntries() {
  const leagueAPI = "https://api.sheety.co/8bc8ea9aa07e26b76e867fe4d92cee28/nbaPlayoffData/leagues";
  const statsAPI = "https://api.sheety.co/8bc8ea9aa07e26b76e867fe4d92cee28/nbaPlayoffData/playerStats";

  Promise.all([
    fetch(leagueAPI).then(res => res.json()),
    fetch(statsAPI).then(res => res.json())
  ])
    .then(([leagueData, statsData]) => {
      const entries = leagueData.leagues || [];
      const playerStats = statsData.playerStats || [];
      const list = document.getElementById("myEntriesList");
      list.innerHTML = "";

      const userEntries = entries.filter(entry => entry.email === window.currentEmail);

      if (userEntries.length === 0) {
        list.innerHTML = `<li>You haven't submitted any drafts yet.</li>`;
        return;
      }

      userEntries.forEach((entry, index) => {
        const picks = JSON.parse(entry.draftPicks);
        let totalPoints = 0;

        const fullRoster = picks.map(name => {
          const stat = playerStats.find(p => p.player === name);
          const points = stat?.points ? Math.round(Number(stat.points)) : 0;
          const eliminated = stat?.eliminated?.toLowerCase() === "yes";
          const teamAbbr = stat?.team?.toUpperCase();
          totalPoints += points;

          return {
            name,
            points,
            eliminated,
            teamAbbr
          };
        });

        const li = document.createElement("li");
        li.style.flexDirection = "column";
        li.style.alignItems = "flex-start";

        const header = document.createElement("div");
        header.style.display = "flex";
        header.style.justifyContent = "space-between";
        header.style.alignItems = "center";
        header.style.width = "100%";

        const label = document.createElement("strong");
        label.textContent = `ğŸ™‹ Entry #${index + 1} â€” ${totalPoints} pts`;

        const toggleBtn = document.createElement("button");
        toggleBtn.textContent = "View Players";
        toggleBtn.style.width = "100px";
        toggleBtn.style.padding = "6px 10px";
        toggleBtn.style.background = "#2980b9";
        toggleBtn.style.color = "#fff";
        toggleBtn.style.border = "none";
        toggleBtn.style.borderRadius = "5px";
        toggleBtn.style.cursor = "pointer";
        toggleBtn.style.fontSize = "0.9rem";

        const playerList = document.createElement("ul");
        playerList.style.marginTop = "8px";
        playerList.style.display = "none";

        toggleBtn.onclick = () => {
          const visible = playerList.style.display === "block";
          playerList.style.display = visible ? "none" : "block";
          toggleBtn.textContent = visible ? "View Players" : "Hide Players";
        };

        const rightButtons = document.createElement("div");
        rightButtons.style.display = "flex";
        rightButtons.style.gap = "6px";
        rightButtons.appendChild(toggleBtn);

        // âœ… Only allow delete if user owns the entry
        if (entry.email === window.currentEmail) {
          const deleteBtn = document.createElement("button");
          deleteBtn.textContent = "ğŸ—‘ï¸";
          deleteBtn.title = "Delete Entry";
          deleteBtn.style.marginLeft = "6px";
          deleteBtn.style.padding = "4px 6px";
          deleteBtn.style.fontSize = "0.8rem";
          deleteBtn.style.background = "#c0392b";
          deleteBtn.style.color = "#fff";
          deleteBtn.style.border = "none";
          deleteBtn.style.borderRadius = "4px";
          deleteBtn.style.cursor = "pointer";

          deleteBtn.onclick = () => {
            if (confirm("Are you sure you want to delete this entry?")) {
              deleteUserEntry(entry.id);
            }
          };

          rightButtons.appendChild(deleteBtn);
        }

        header.appendChild(label);
        header.appendChild(rightButtons);
        li.appendChild(header);

        fullRoster.forEach(player => {
          const detail = document.createElement("li");
          const logo = teamLogos[player.teamAbbr];

          detail.innerHTML = `
            ${logo ? `<img src="${logo}" style="height:16px;margin-right:6px;">` : ""}
            ${player.eliminated ? "âŒ " : ""}${player.name} - ${player.points} pts
          `;

          if (player.eliminated) {
            detail.style.opacity = "0.6";
            detail.style.fontStyle = "italic";
          }

          detail.style.marginLeft = "16px";
          detail.style.fontSize = "0.95rem";
          playerList.appendChild(detail);
        });

        li.appendChild(playerList);
        list.appendChild(li);
      });
    })
    .catch(err => {
      console.error("âŒ Error loading user entries:", err);
      alert("Failed to load your entries.");
    });
}


function deleteUserEntry(entryId) {
  if (!entryId || typeof entryId !== "number") {
    console.error("âŒ Invalid entry ID:", entryId);
    alert("Cannot delete this entry. Invalid ID.");
    return;
  }

  const url = `https://api.sheety.co/8bc8ea9aa07e26b76e867fe4d92cee28/nbaPlayoffData/leagues/${entryId}`;
  console.log("ğŸ—‘ï¸ Attempting to delete entry with ID:", entryId);

  fetch(url, {
    method: "DELETE",
    headers: {
      "Content-Type": "application/json"
    }
  })
    .then(async res => {
      const responseText = await res.text();
      console.log("ğŸ§¾ DELETE response text:", responseText);

      if (!res.ok) {
        throw new Error(`Delete failed. Status: ${res.status}, Body: ${responseText}`);
      }

      alert("âœ… Entry deleted successfully.");

      // âœ… Add a small delay before reload to ensure API updates propagate
      setTimeout(() => {
        loadMyEntries(); // Force reload fresh from API
      }, 500);
    })
    .catch(err => {
      console.error("âŒ Error while deleting entry:", err);
      alert("Failed to delete entry. Check the console for details.");
    });
}
function continueAsGuest() {
  const randomSuffix = Math.floor(Math.random() * 10000);
  const guestName = `Guest${randomSuffix}`;

  window.currentUser = guestName;
  window.currentEmail = `${guestName}@guest.local`; // used for display & optional draft saving

  document.getElementById("loginForm").style.display = "none";
  document.getElementById("loginScreen").classList.remove("visible");
  document.getElementById("usernameDisplay").textContent = window.currentUser;

  showScreen("mainMenu");
}

    
function goToMyEntries() {
  showScreen("myEntriesScreen");
  loadMyEntries();
}
function isDraftLocked() {
  const lockDate = new Date("2025-04-15T23:30:00Z"); // Local time 7:00PM
  const now = new Date();
  return now >= lockDate;
}
function loadAdSenseScriptOnce() {
  if (window.adsbygoogleLoaded) return;

  const script = document.createElement('script');
  script.src = "https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5319541186981982";
  script.async = true;
  script.crossOrigin = "anonymous";
  document.head.appendChild(script);

  window.adsbygoogleLoaded = true;
}
function goToDraft() {
  if (isDraftLocked()) {
    alert("ğŸš« Drafting is locked. Lineups are final.");
    return;
  }

  drafted = new Set();
  draftPicks = [];
  showScreen("draftScreen");

  setTimeout(() => {
    startDraft();
  }, 100);
}


    
function backToHome() {
  showScreen("mainMenu");
}
auth.onAuthStateChanged(user => {
  if (user) {
    console.log("âœ… User already logged in:", user.email);
    window.currentUser = user.email.split("@")[0];
    window.currentEmail = user.email;

    document.getElementById("loginForm").style.display = "none";
    document.getElementById("loginScreen").classList.remove("visible");
    document.getElementById("usernameDisplay").textContent = window.currentUser;
    showScreen("mainMenu");
  }
});



window.addEventListener("DOMContentLoaded", () => {
  loadLiveLeaderboard();
});



  </script>
</body>
</html>

